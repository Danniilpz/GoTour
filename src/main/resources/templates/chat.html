<!--Fuente: https://bootsnipp.com/snippets/1ea0N-->
<!DOCTYPE html>
<html
    xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head><th:block th:replace="fragments/head :: header"/>
    <title>Chat</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito+Sans:200,300,400,700,900|Roboto+Mono:300,400,500"> 
    <link rel="stylesheet" th:href="@{/fonts/icomoon/style.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}">
    <link rel="stylesheet" th:href="@{/css/jquery-ui.css}">
    <link rel="stylesheet" th:href="@{/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/css/owl.theme.default.min.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap-datepicker.css}">
    <link rel="stylesheet" th:href="@{/css/mediaelementplayer.css}">
    <link rel="stylesheet" th:href="@{/css/animate.css}">
    <link rel="stylesheet" th:href="@{/fonts/flaticon/font/flaticon.css}">
    <link rel="stylesheet" th:href="@{/css/fl-bigmug-line.css}">
    <link rel="stylesheet" th:href="@{/css/aos.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css"
        rel="stylesheet" >
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <link th:href="@{/css/chat.css}" rel="stylesheet">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
    <nav th:replace="fragments/nav.html :: nav">
		Nav goes here
	</nav>
    <div th:replace="fragments/imagenes-principales.html :: images-principales">
     
    </div>

    <div class="container user_id" th:id="${user_id}">
        <h3 class="text-center tour_id" th:id="${tour_id}">Chat del tour </h3>
        <div class="messaging topic_id" th:id="${topic_id}">
            <div class="inbox_msg">
                <!--<div class="inbox_people">
                    <div class="headind_srch">
                        <div class="recent_heading">
                            <h4>Recent</h4>
                        </div>
                        <div class="srch_bar">
                            <div class="stylish-input-group">
                                <input type="text" class="search-bar" placeholder="Search">
                                <span class="input-group-addon">
                                    <button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="inbox_chat">
                        <div class="chat_list active_chat">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>-->
                <div class="mesgs">
                    <div class="msg_history" id="tablon">
                       
                    </div>
                    <div class="type_msg">
                        <form class="input_msg_write" th:action="@{'/tour/'+${tour_id}+'/msg'}" method="POST">
                            <input type="text" class="write_msg" id="message" placeholder="Type a message" />
                            <button class="msg_send_btn" id="sendmsg" type="submit"><i class="fa fa-paper-plane-o"
                                    aria-hidden="true"></i></button>
                        </form>
                    </div>
                </div>
            </div>


            <!--<p class="text-center top_spac"> Design by <a target="_blank"
                    href="https://www.linkedin.com/in/sunil-rajput-nattho-singh/">Sunil Rajput</a></p>-->

        </div>
    </div>

    <nav th:replace="fragments/footer.html :: footer">
        Nav goes here
      </nav>

    <script>
        const tour_id = document.getElementsByClassName("tour_id")[0].id;
        const user_id = document.getElementsByClassName("user_id")[0].id;

        function formatDate(d) {
            // 2020-03-23T10:48:11.074 => 23/3/2020@10:48:18
            return new Date(d).toLocaleString("es-ES").split(" ").join(" ")
	    }

        // mostrando una tabla dinámica con datos cargados del servidor vía AJAX
        $.ajax({
            type:"GET",
            url: config.rootUrl + "mensaje/tour/"+tour_id+"/received",
            success: function(data){
                data.forEach(element => {
                    procesarMensaje(element);
                });
            }
        });

        // envío de mensajes vía AJAX, sin recargar la página
        document.addEventListener("DOMContentLoaded", () => {
            let b = document.getElementById("sendmsg");
            b.onclick = (e) => {
                    let url = b.parentNode.action;
                    e.preventDefault();
                    console.log(b, b.parentNode)
                    go(url, 'POST', {message: 
                            document.getElementById("message").value})
                        .then(d => {
                            document.getElementById("message").value = '';
                        })
                        .catch(e => console.log("sad", e))
                }
        });

        ws.receive = (m) => {
            procesarMensaje(m);
        }

        function getFoto(id) {

            $.ajax({
            type:"GET",
            url: config.rootUrl + "/user/"+id+"/foto",
            success: function(data){
                console.log(url);
                console.log(data);
                return data;
            }
        });
        }
        function procesarMensaje(m){
            const my_id = user_id;
            const element = document.getElementById("tablon");

            if(my_id == m.id_sender){
                /*
                <div class="outgoing_msg">
                    <div class="sent_msg">
                        <p>Apollo University, Delhi, India Test</p>
                        <span class="time_date"> 11:01 AM | Today</span>
                    </div>
                </div>
                */

                let node1 = document.createElement('div');
                node1.className = "outgoing_msg";

                let node2 = document.createElement('div');
                node2.className = "sent_msg";

                let node3 = document.createElement('p');
                let mensaje = document.createTextNode(m.text);
                node3.appendChild(mensaje);

                let node4 = document.createElement('span');
                node4.className = "time_date";
                let fecha = document.createTextNode(formatDate(new Date().toISOString()));
                node4.appendChild(fecha);

                element.appendChild(node1);
                node1.appendChild(node2);
                node2.appendChild(node3);
                node2.appendChild(node4);
            }else {
                /*
                <div class="incoming_msg">
                    <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                            alt="sunil"> </div>
                    <div class="received_msg">
                        <div class="received_withd_msg">
                            <p>Test, which is a new approach to have</p>
                            <span class="time_date"> 11:01 AM | Yesterday</span>
                        </div>
                    </div>
                </div>
                */

                let node1 = document.createElement('div');
                node1.className = "incoming_msg";

                let node11 = document.createElement('div');
                node11.className = "incoming_msg_img";
                let foto = document.createElement('img');
                foto.className = "avatar";
               //foto.src = (m.img_sender != null) ? getFoto() : "https://ptetutorials.com/images/user-profile.png";
               foto.src = getFoto(m.id_sender);
                //<img class="img guia_tour_foto" th:src="@{/user/{id}/foto(id=${user.Id})}" alt="La imagen del guia" >
                node11.appendChild(foto);

                let nodo12 = document.createElement('h3');
                nodo12.className = "nombre";
                let  nombre = document.createTextNode(m.from);
                nodo12.appendChild(nombre);

                let node2 = document.createElement('div');
                node2.className = "received_msg";

                let node21 = document.createElement('div');
                node21.className = "received_withd_msg";

                let node211 = document.createElement('p');
                let mensaje = document.createTextNode(m.text);
                node211.appendChild(mensaje);

                let node212 = document.createElement('span');
                node212.className = "time_date";
                let fecha = document.createTextNode(formatDate(new Date().toISOString()));
                node212.appendChild(fecha);

                element.appendChild(node1);
                node1.appendChild(node11);
                node1.appendChild(nodo12);

                element.appendChild(node2);
                node2.appendChild(node21);
                node21.appendChild(node211);
                node21.appendChild(node212);
            }
        }

    </script>
    <script th:src="@{~/js/jquery-migrate-3.0.1.min.js}"></script>
    <script th:src="@{~/js/jquery-3.3.1.min.js}"></script>
    <script th:src="@{~/js/popper.min.js}"></script>
    <script th:src="@{~/js/jquery-ui.js}"></script>
    <script th:src="@{~/js/owl.carousel.min.js}"></script>
    <script th:src="@{~/js/bootstrap.min.js}"></script>
    <script th:src="@{~/js/jquery.stellar.min.js}"></script>
    <script th:src="@{~/js/mediaelement-and-player.min.js}"></script>
    <script th:src="@{~/js/jquery.magnific-popup.min.js}"></script>
    <script th:src="@{~/js/jquery.countdown.min.js}"></script>
    <script th:src="@{~/js/aos.js}"></script>
    <script th:src="@{~/js/bootstrap-datepicker.min.js}"></script>
    <script th:src="@{~/js/circleaudioplayer.js}"></script>
    <script th:src="@{~/js/main.js}"></script>
</body>

</html>