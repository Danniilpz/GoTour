<!--Fuente: https://bootsnipp.com/snippets/1ea0N-->
<!DOCTYPE html>
<html
    xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head><th:block th:replace="fragments/head :: header"/>
    <title>Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css"
        rel="stylesheet" >
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <link th:href="@{/css/chat.css}" rel="stylesheet">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
    <div class="container" th:id="${user_id}">
        <h3 class="text-center tour_id" th:id="${tour_id}">Chat del tour </h3>
        <div class="messaging">
            <div class="inbox_msg">
                <!--<div class="inbox_people">
                    <div class="headind_srch">
                        <div class="recent_heading">
                            <h4>Recent</h4>
                        </div>
                        <div class="srch_bar">
                            <div class="stylish-input-group">
                                <input type="text" class="search-bar" placeholder="Search">
                                <span class="input-group-addon">
                                    <button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="inbox_chat">
                        <div class="chat_list active_chat">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat_list">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                                        alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                                    <p>Test, which is a new approach to have all solutions
                                        astrology under one roof.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>-->
                <div class="mesgs">
                    <div class="msg_history" id="tablon">
                       
                    </div>
                    <div class="type_msg">
                        <form class="input_msg_write" th:action="@{'/tour/'+${tour_id}+'/msg'}" method="POST">
                            <input type="text" class="write_msg" id="message" placeholder="Type a message" />
                            <button class="msg_send_btn" id="sendmsg" type="submit"><i class="fa fa-paper-plane-o"
                                    aria-hidden="true"></i></button>
                        </form>
                    </div>
                </div>
            </div>


            <!--<p class="text-center top_spac"> Design by <a target="_blank"
                    href="https://www.linkedin.com/in/sunil-rajput-nattho-singh/">Sunil Rajput</a></p>-->

        </div>
    </div>
    <script>
        var tour_id = document.getElementsByClassName("tour_id")[0].id;

        function formatDate(d) {
            // 2020-03-23T10:48:11.074 => 23/3/2020@10:48:18
            return new Date(d).toLocaleString("es-ES").split(" ").join(" ")
	    }

        // mostrando una tabla dinámica con datos cargados del servidor vía AJAX
        $.ajax({
            type:"GET",
            url: config.rootUrl + "mensaje/tour/"+tour_id+"/received",
            success: function(data){
                data.forEach(element => {
                    procesarMensaje(element);
                });
            }
        });

        // envío de mensajes vía AJAX, sin recargar la página
        document.addEventListener("DOMContentLoaded", () => {
            let b = document.getElementById("sendmsg");
            b.onclick = (e) => {
                let url = b.parentNode.action;
                e.preventDefault();
                console.log(b, b.parentNode)
                go(url, 'POST', {message: 
                        document.getElementById("message").value})
                    .then(d => console.log("happy", d))
                    .catch(e => console.log("sad", e))
            }
        });

        ws.receive = (m) => {
            procesarMensaje(m);
        }

        function procesarMensaje(m){
            var my_id = document.getElementsByClassName("container")[0].id;
            if(my_id == m.id_sender){
                /*
                <div class="outgoing_msg">
                    <div class="sent_msg">
                        <p>Apollo University, Delhi, India Test</p>
                        <span class="time_date"> 11:01 AM | Today</span>
                    </div>
                </div>
                */
                var  element = document.getElementById("tablon");

                var node1 = document.createElement('div');
                node1.className = "outgoing_msg";

                var node2 = document.createElement('div');
                node2.className = "sent_msg";

                var node3 = document.createElement('p');
                var mensaje = document.createTextNode(m.text);
                node3.appendChild(mensaje);

                var node4 = document.createElement('span');
                node4.className = "time_date";
                var fecha = document.createTextNode(formatDate(new Date().toISOString()));
                node4.appendChild(fecha);

                element.appendChild(node1);
                node1.appendChild(node2);
                node2.appendChild(node3);
                node2.appendChild(node4);
            }else {
                /*
                <div class="incoming_msg">
                    <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                            alt="sunil"> </div>
                    <div class="received_msg">
                        <div class="received_withd_msg">
                            <p>Test, which is a new approach to have</p>
                            <span class="time_date"> 11:01 AM | Yesterday</span>
                        </div>
                    </div>
                </div>
                */
                var  element = document.getElementById("tablon");

                var node1 = document.createElement('div');
                node1.className = "incoming_msg";

                var node11 = document.createElement('div');
                node11.className = "incoming_msg_img";
                var foto = document.createElement('img');
                foto.src = (m.img_sender != null) ? m.img_sender : "https://ptetutorials.com/images/user-profile.png";
                node11.appendChild(foto);

                var nodo12 = document.createElement('h3');
                nodo12.className = "nombre";
                var  nombre = document.createTextNode(m.from);
                nodo12.appendChild(nombre);

                var node2 = document.createElement('div');
                node2.className = "received_msg";

                var node21 = document.createElement('div');
                node21.className = "received_withd_msg";

                var node211 = document.createElement('p');
                var mensaje = document.createTextNode(m.text);
                node211.appendChild(mensaje);

                var node212 = document.createElement('span');
                node212.className = "time_date";
                var fecha = document.createTextNode(formatDate(new Date().toISOString()));
                node212.appendChild(fecha);

                element.appendChild(node1);
                node1.appendChild(node11);
                node1.appendChild(nodo12);

                element.appendChild(node2);
                node2.appendChild(node21);
                node21.appendChild(node211);
                node21.appendChild(node212);
            }
        }

    </script>
</body>

</html>